<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Experience Studio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <style>
      .page { max-width: 1200px; }
      label{font-size:.92rem;display:flex;flex-direction:column;gap:.25rem}
      #status{min-height:1.2rem;}
    </style>
  </head>
  <body>
    <div class="page stack">
      <h1>Experience Studio</h1>
      <p>Flexibly map rules parameters into customer-facing controls without changing evaluation logic. Workflow: RuleCanvas → Experience Studio → Approval → Deployment.</p>
      <p><a href="http://localhost:8000">Back to Launchpad Orbit</a></p>
      <form method="post" action="/logout"><button type="submit">Logout</button></form>

      <div class="card">
        <h2>Parameter Mapping Editor</h2>
        <div class="grid-3">
          <label>Ruleset ID<input id="ruleset_id" type="number" min="1" value="1" /></label>
          <label>Parameter Name<input id="parameter_name" placeholder="quantity" /></label>
          <label>Display Label<input id="display_label" placeholder="Order Quantity" /></label>
          <label>Control Type
            <select id="control_type">
              <option value="text">Text Input</option>
              <option value="number">Number Input</option>
              <option value="radio_boolean">Radio Yes/No</option>
              <option value="slider">Slider</option>
              <option value="dropdown">Dropdown</option>
              <option value="button_group">Toggle Button Group</option>
            </select>
          </label>
          <label>Display Style
            <select id="display_style">
              <option value="classic">Classic</option>
              <option value="card">Card</option>
              <option value="accent">Accent</option>
              <option value="pill">Pill</option>
              <option value="tile">Tile</option>
            </select>
          </label>
          <label>Min Value<input id="min_value" type="number" step="0.01" /></label>
          <label>Max Value<input id="max_value" type="number" step="0.01" /></label>
          <label>Step<input id="step_value" type="number" step="0.01" /></label>
          <label>Placeholder<input id="placeholder" /></label>
          <label>Parameter Image URL<input id="image_url" placeholder="https://..." /></label>
          <label>Value Image Mode
            <select id="value_image_mode">
              <option value="none">No value images</option>
              <option value="value">Show value images</option>
            </select>
          </label>
        </div>
        <label>Help Text<textarea id="help_text"></textarea></label>
        <label><input type="checkbox" id="is_required" /> Force required in UI</label>
        <label>Options (one per line: value|label|image-url)<textarea id="options"></textarea></label>
        <button type="button" id="save" class="primary">Save Mapping</button>
        <p id="status"></p>
      </div>

      <div class="card">
        <h2>Saved mappings</h2>
        <p id="governance"></p>
        <table>
          <thead><tr><th>Parameter</th><th>Label</th><th>Control</th><th>Style</th><th>Options</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
    <script>
      function parseOptions(raw){
        return raw.split('\n').map((line, index)=>{
          const parts = line.split('|').map(x=>x.trim());
          if(!parts[0]) return null;
          return {value: parts[0], label: parts[1] || parts[0], image_url: parts[2] || '', order: index + 1};
        }).filter(Boolean);
      }

      async function refresh(){
        const rid = document.getElementById('ruleset_id').value || '1';
        const res = await fetch(`/api/mappings?ruleset_id=${encodeURIComponent(rid)}`);
        const body = await res.json();
        const rows = document.getElementById('rows');
        rows.innerHTML = '';
        document.getElementById('governance').textContent = `Governance parameters: ${Object.keys(body.governance || {}).length}`;
        body.mappings.forEach((mapping)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${mapping.parameter_name}</td><td>${mapping.display_label}</td><td>${mapping.control_type}</td><td>${mapping.display_style}</td><td>${mapping.options.length}</td>`;
          rows.appendChild(tr);
        });
      }

      document.getElementById('save').onclick = async ()=>{
        const payload = {
          ruleset_id: Number(document.getElementById('ruleset_id').value),
          parameter_name: document.getElementById('parameter_name').value,
          display_label: document.getElementById('display_label').value,
          control_type: document.getElementById('control_type').value,
          display_style: document.getElementById('display_style').value,
          min_value: document.getElementById('min_value').value || null,
          max_value: document.getElementById('max_value').value || null,
          step_value: document.getElementById('step_value').value || null,
          placeholder: document.getElementById('placeholder').value,
          image_url: document.getElementById('image_url').value,
          value_image_mode: document.getElementById('value_image_mode').value,
          help_text: document.getElementById('help_text').value,
          is_required: document.getElementById('is_required').checked,
          options: parseOptions(document.getElementById('options').value)
        };
        const res = await fetch('/api/mappings', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        document.getElementById('status').textContent = res.ok ? 'Saved.' : 'Failed to save.';
        await refresh();
      };

      document.getElementById('ruleset_id').addEventListener('change', refresh);
      refresh();
    </script>
  </body>
</html>
