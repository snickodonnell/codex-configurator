<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rules Engine</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <style>
      .layout { display: grid; grid-template-columns: 340px 1fr; gap: 1rem; align-items: start; }
      .products button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
      textarea { min-height: 160px; font-family: ui-monospace, monospace; }
      .workspace { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }
      .category { border: 1px solid var(--border); border-radius: 12px; padding: .8rem; background: #fbfdff; }
      .rule { border: 1px solid var(--border); border-radius: 10px; padding: .6rem; margin-top: .45rem; background: #fff; }
      .rule.readonly { opacity: .95; }
      .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .6rem; }
      .status { min-height: 1.2rem; }
      @media (max-width: 1100px) {
        .layout { grid-template-columns: 1fr; }
        .workspace { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="topbar">
        <div>
          <h1 style="margin:0">Rules Editor Workspace</h1>
          <div class="muted">Design product rule catalogs with safe editing, hierarchy controls, and execution ordering.</div>
        </div>
        <form method="post" action="/logout"><button type="submit">Logout</button></form>
      </div>

      <div class="layout">
        <section class="card products">
          <h3>Products</h3>
          <div id="productList" class="stack"></div>
          <div class="stack" style="margin-top:.8rem">
            <input id="newProductName" placeholder="New product name" />
            <input id="newProductDescription" placeholder="Description" />
            <button id="addProductBtn" class="primary" type="button">Add product</button>
          </div>
          <div id="workspaceStatus" class="status muted" role="status" aria-live="polite"></div>
        </section>

        <section class="stack">
          <article class="card">
            <h3 id="activeProductTitle">Rules catalog</h3>
            <div class="workspace" id="workspace"></div>
          </article>

          <article class="card" data-ui-region="ruleset-editor">
            <h3>{% if selected_ruleset %}Edit ruleset #{{ selected_ruleset.id }}{% else %}Create ruleset{% endif %}</h3>
            {% if parse_error %}<p style="color:#b91c1c">Unable to save rules: {{ parse_error }}</p>{% endif %}
            <form method="post" action="/rulesets">
              {% if selected_ruleset %}<input type="hidden" name="ruleset_id" value="{{ selected_ruleset.id }}" />{% endif %}
              <div class="grid2">
                <input name="name" value="{{ selected_ruleset.name if selected_ruleset else 'Default Rules' }}" placeholder="Name" />
                <input name="environment" value="{{ selected_ruleset.environment if selected_ruleset else 'dev' }}" placeholder="Environment" />
                <input id="rulesetProduct" name="product_name" value="{{ selected_ruleset.product_name if selected_ruleset else 'laptop' }}" placeholder="Product" />
                <input type="number" min="1" name="version" value="{{ selected_ruleset.version if selected_ruleset else 1 }}" placeholder="Version" />
                <input name="category" value="{{ selected_ruleset.category if selected_ruleset else 'pricing' }}" placeholder="Category" />
                <input name="subcategory" value="{{ selected_ruleset.subcategory if selected_ruleset else 'discounts' }}" placeholder="Subcategory" />
              </div>
              <p class="muted">Rules DSL</p>
              <textarea name="pseudo_rules" id="pseudo_rules">{{ selected_pseudocode if selected_pseudocode else "DEFAULT discount = 0.05\nCONSTRAINT quantity >= 1 :: Quantity must be at least 1\nCALC total_price = base_price * quantity * (1 - discount)" }}</textarea>
              <details><summary>Raw JSON payload</summary><textarea name="payload">{{ selected_ruleset.payload if selected_ruleset else '' }}</textarea></details>
              <div class="row" style="margin-top:.6rem">
                <button id="loadWorkspaceRulesBtn" type="button">Load from workspace</button>
                <button class="primary" type="submit">{% if selected_ruleset %}Update{% else %}Save{% endif %}</button>
              </div>
            </form>
          </article>

          <article class="card" data-ui-region="ruleset-browser">
            <h3>Existing rulesets</h3>
            {% for ruleset in rulesets %}
            <div class="row wrap" style="justify-content:space-between; border-top:1px solid var(--border); padding-top:.45rem; margin-top:.45rem;">
              <div>
                <strong>#{{ ruleset.id }} {{ ruleset.name }}</strong>
                <div class="muted">{{ ruleset.product_name }} / {{ ruleset.category }} / {{ ruleset.subcategory }} • v{{ ruleset.version }} • {{ ruleset.environment }}</div>
              </div>
              <div class="row wrap">
                {% set workflow = workflows.get(ruleset.id) %}
                <span class="pill">{{ workflow.state if workflow else 'draft' }}</span>
                {% if workflow and workflow.requires_ux_update %}<span class="pill" style="background:#fee2e2;color:#991b1b">UX Update Required</span>{% endif %}
                <form method="get" action="/"><input type="hidden" name="edit" value="{{ ruleset.id }}" /><button type="submit">Edit</button></form>
                <form method="post" action="/workflow/{{ ruleset.id }}/send-to-studio"><button type="submit">Send to Studio</button></form>
                <form method="post" action="/workflow/{{ ruleset.id }}/request-approval"><button type="submit">Request Approval</button></form>
                <form method="post" action="/workflow/{{ ruleset.id }}/approve"><button type="submit">Approve</button></form>
                <form method="post" action="/deploy/{{ ruleset.id }}"><input name="environment" value="{{ ruleset.environment }}" style="width:80px"/><button type="submit">Deploy</button></form>
              </div>
            </div>
            {% else %}<p class="muted">No rulesets yet.</p>{% endfor %}
          </article>

          <article class="card"><h3>Active deployments</h3><ul>{% for deployment in deployments %}<li>{{ deployment.environment }} => ruleset #{{ deployment.ruleset_id }} at {{ deployment.deployed_at }}</li>{% else %}<li>No deployments yet.</li>{% endfor %}</ul><form method="post" action="/rollback" class="row" style="margin-top:.6rem"><input name="environment" value="dev" style="width:90px"/><button type="submit">Rollback</button></form></article>
        </section>
      </div>
    </div>

    <script>
      var workspaceData = { products: [] };
      var activeProductId = null;

      function statusMessage(message, isError) {
        var node = document.getElementById("workspaceStatus");
        node.textContent = message || "";
        node.style.color = isError ? "#b91c1c" : "";
      }

      function toText(value) {
        return value == null ? "" : String(value);
      }

      function activeProduct() {
        return workspaceData.products.find(function (p) { return p.id === activeProductId; }) || null;
      }

      async function fetchJson(url, opts) {
        var request = opts || {};
        var headers = request.headers || {};
        headers["Content-Type"] = "application/json";
        request.headers = headers;
        var response = await fetch(url, request);
        if (!response.ok) {
          throw new Error(await response.text());
        }
        return response.json();
      }

      function buildButton(label, className, onClick) {
        var button = document.createElement("button");
        button.type = "button";
        button.textContent = label;
        if (className) button.className = className;
        button.addEventListener("click", onClick);
        return button;
      }

      function createReadOnlyRule(rule) {
        var wrapper = document.createElement("div");
        wrapper.className = "rule readonly";

        var top = document.createElement("div");
        top.className = "row wrap";

        var typePill = document.createElement("span");
        typePill.className = "pill";
        typePill.textContent = toText(rule.rule_type);
        top.appendChild(typePill);

        var order = document.createElement("strong");
        order.textContent = "#" + toText(rule.position);
        top.appendChild(order);

        var code = document.createElement("code");
        code.textContent = toText(rule.expression);
        top.appendChild(code);

        top.appendChild(buildButton("Edit", "", function () { setEditable(rule.id, true); }));
        top.appendChild(buildButton("↑", "", function () { moveRule(rule.id, Number(rule.position) - 1); }));
        top.appendChild(buildButton("↓", "", function () { moveRule(rule.id, Number(rule.position) + 1); }));
        top.appendChild(buildButton("Delete", "danger", function () { deleteRule(rule.id); }));

        wrapper.appendChild(top);

        var message = document.createElement("div");
        message.className = "muted";
        message.textContent = toText(rule.message);
        wrapper.appendChild(message);
        return wrapper;
      }

      function createEditableRule(rule) {
        var wrapper = document.createElement("div");
        wrapper.className = "rule";

        var grid = document.createElement("div");
        grid.className = "grid2";

        var type = document.createElement("select");
        ["constraint", "calculation", "default"].forEach(function (optionValue) {
          var option = document.createElement("option");
          option.value = optionValue;
          option.textContent = optionValue;
          if (rule.rule_type === optionValue) option.selected = true;
          type.appendChild(option);
        });
        type.id = "type-" + rule.id;

        var target = document.createElement("input");
        target.id = "target-" + rule.id;
        target.placeholder = "target field (for default/calculation)";
        target.value = toText(rule.target);

        var expression = document.createElement("input");
        expression.id = "expr-" + rule.id;
        expression.placeholder = "expression";
        expression.value = toText(rule.expression);
        expression.style.gridColumn = "span 2";

        var message = document.createElement("input");
        message.id = "msg-" + rule.id;
        message.placeholder = "message (for constraints)";
        message.value = toText(rule.message);
        message.style.gridColumn = "span 2";

        grid.appendChild(type);
        grid.appendChild(target);
        grid.appendChild(expression);
        grid.appendChild(message);

        var actions = document.createElement("div");
        actions.className = "row";
        actions.appendChild(buildButton("Save", "primary", function () { saveRule(rule.id, Number(rule.position)); }));
        actions.appendChild(buildButton("Readonly", "", function () { setEditable(rule.id, false); }));

        wrapper.appendChild(grid);
        wrapper.appendChild(actions);
        return wrapper;
      }

      function renderRule(rule) {
        return rule.is_editable ? createEditableRule(rule) : createReadOnlyRule(rule);
      }

      function createCategoryHeader(category, categoryLabel, onAddRule, extraActions) {
        var row = document.createElement("div");
        row.className = "row wrap";

        var title = document.createElement("strong");
        title.textContent = toText(category.name);
        row.appendChild(title);

        var pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = categoryLabel;
        row.appendChild(pill);

        extraActions.forEach(function (action) { row.appendChild(action); });
        row.appendChild(buildButton("+ Rule", "", onAddRule));
        return row;
      }

      function renderWorkspace() {
        var product = activeProduct();
        document.getElementById("activeProductTitle").textContent = product ? "Rules for " + product.name : "Rules catalog";
        document.getElementById("rulesetProduct").value = product ? product.name : "";

        var root = document.getElementById("workspace");
        root.innerHTML = "";
        if (!product) return;

        product.categories.forEach(function (category) {
          var card = document.createElement("div");
          card.className = "category";

          var header = createCategoryHeader(
            category,
            "category",
            function () { addRule(category.id, null); },
            [
              buildButton("↑", "", function () { moveCategory(category.id, -1, category.name, category.position); }),
              buildButton("↓", "", function () { moveCategory(category.id, 1, category.name, category.position); }),
              buildButton("Edit", "", function () { renameCategory(category.id, category.name, category.position); }),
              buildButton("Delete", "danger", function () { deleteCategory(category.id); }),
              buildButton("+ Sub-category", "", function () { addSubcategory(category.id); })
            ]
          );
          card.appendChild(header);

          category.rules.forEach(function (rule) { card.appendChild(renderRule(rule)); });

          category.subcategories.forEach(function (subcategory) {
            var subCard = document.createElement("div");
            subCard.className = "category";
            subCard.style.marginTop = ".5rem";

            subCard.appendChild(
              createCategoryHeader(
                subcategory,
                "sub-category",
                function () { addRule(category.id, subcategory.id); },
                [
                  buildButton("Edit", "", function () { renameCategory(subcategory.id, subcategory.name, subcategory.position); }),
                  buildButton("Delete", "danger", function () { deleteCategory(subcategory.id); })
                ]
              )
            );

            subcategory.rules.forEach(function (rule) { subCard.appendChild(renderRule(rule)); });
            card.appendChild(subCard);
          });

          root.appendChild(card);
        });

        root.appendChild(buildButton("+ Category", "primary", addCategory));
      }

      function renderProducts() {
        var node = document.getElementById("productList");
        node.innerHTML = "";

        workspaceData.products.forEach(function (product) {
          var row = document.createElement("div");
          row.className = "row wrap";

          var switchBtn = buildButton(product.name, product.id === activeProductId ? "active" : "", function () {
            activeProductId = product.id;
            renderProducts();
            renderWorkspace();
          });
          row.appendChild(switchBtn);

          row.appendChild(buildButton("Delete", "danger", function () { deleteProduct(product.id); }));
          node.appendChild(row);
        });
      }

      async function loadWorkspace() {
        try {
          workspaceData = await fetchJson("/api/workspace");
          if (!activeProductId && workspaceData.products.length > 0) {
            activeProductId = workspaceData.products[0].id;
          }
          renderProducts();
          renderWorkspace();
          statusMessage("");
        } catch (error) {
          statusMessage("Could not load workspace: " + error.message, true);
        }
      }

      async function createProduct() {
        var name = document.getElementById("newProductName").value.trim();
        var description = document.getElementById("newProductDescription").value.trim();
        if (!name) {
          statusMessage("Product name is required", true);
          return;
        }
        await fetchJson("/api/workspace/products", { method: "POST", body: JSON.stringify({ name: name, description: description }) });
        document.getElementById("newProductName").value = "";
        document.getElementById("newProductDescription").value = "";
        await loadWorkspace();
      }

      async function deleteProduct(productId) {
        if (!window.confirm("Delete this product and all its categories/rules?")) return;
        await fetchJson("/api/workspace/products/" + productId, { method: "DELETE" });
        if (activeProductId === productId) activeProductId = null;
        await loadWorkspace();
      }

      async function addCategory() {
        var product = activeProduct();
        if (!product) return;
        await fetchJson("/api/workspace/categories", {
          method: "POST",
          body: JSON.stringify({ product_id: product.id, name: "New Category", position: product.categories.length + 1 })
        });
        await loadWorkspace();
      }

      async function addSubcategory(parentId) {
        var product = activeProduct();
        if (!product) return;
        await fetchJson("/api/workspace/categories", {
          method: "POST",
          body: JSON.stringify({ product_id: product.id, parent_id: parentId, name: "New Sub-category", position: 99 })
        });
        await loadWorkspace();
      }

      async function renameCategory(categoryId, currentName, position) {
        var nextName = window.prompt("Category name", currentName);
        if (!nextName) return;
        await fetchJson("/api/workspace/categories/" + categoryId, {
          method: "PUT",
          body: JSON.stringify({ name: nextName.trim(), position: position })
        });
        await loadWorkspace();
      }

      async function moveCategory(categoryId, delta, name, currentPosition) {
        await fetchJson("/api/workspace/categories/" + categoryId, {
          method: "PUT",
          body: JSON.stringify({ name: name, position: Math.max(1, Number(currentPosition || 1) + delta) })
        });
        await loadWorkspace();
      }

      async function deleteCategory(categoryId) {
        if (!window.confirm("Delete this category and all child rules?")) return;
        await fetchJson("/api/workspace/categories/" + categoryId, { method: "DELETE" });
        await loadWorkspace();
      }

      async function addRule(categoryId, subcategoryId) {
        var product = activeProduct();
        if (!product) return;
        await fetchJson("/api/workspace/rules", {
          method: "POST",
          body: JSON.stringify({
            product_id: product.id,
            category_id: categoryId,
            subcategory_id: subcategoryId,
            rule_type: "constraint",
            expression: "quantity >= 1",
            message: "Required",
            position: 99
          })
        });
        await loadWorkspace();
      }

      async function setEditable(ruleId, isEditable) {
        await fetchJson("/api/workspace/rules/" + ruleId + "/editable", {
          method: "POST",
          body: JSON.stringify({ is_editable: isEditable })
        });
        await loadWorkspace();
      }

      async function saveRule(ruleId, position) {
        await fetchJson("/api/workspace/rules/" + ruleId, {
          method: "PUT",
          body: JSON.stringify({
            rule_type: document.getElementById("type-" + ruleId).value,
            target: document.getElementById("target-" + ruleId).value,
            expression: document.getElementById("expr-" + ruleId).value,
            message: document.getElementById("msg-" + ruleId).value,
            position: position,
            is_editable: true
          })
        });
        await loadWorkspace();
      }

      async function moveRule(ruleId, position) {
        await fetchJson("/api/workspace/rules/" + ruleId + "/position", {
          method: "POST",
          body: JSON.stringify({ position: Math.max(1, position) })
        });
        await loadWorkspace();
      }

      async function deleteRule(ruleId) {
        await fetchJson("/api/workspace/rules/" + ruleId, { method: "DELETE" });
        await loadWorkspace();
      }

      function exportWorkspaceRules() {
        var product = activeProduct();
        if (!product) return;

        var lines = [];
        product.categories.forEach(function (category) {
          var rules = category.rules.slice();
          category.subcategories.forEach(function (subcategory) {
            subcategory.rules.forEach(function (rule) { rules.push(rule); });
          });
          rules.sort(function (a, b) { return Number(a.position) - Number(b.position); });
          rules.forEach(function (rule) {
            if (rule.rule_type === "calculation") {
              lines.push("CALC " + (rule.target || "result") + " = " + rule.expression);
            } else if (rule.rule_type === "default") {
              lines.push("DEFAULT " + (rule.target || "field") + " = " + rule.expression);
            } else {
              lines.push("CONSTRAINT " + rule.expression + " :: " + (rule.message || "Rule violation"));
            }
          });
        });

        document.getElementById("pseudo_rules").value = lines.join("\n");
      }

      document.getElementById("addProductBtn").addEventListener("click", function () {
        createProduct().catch(function (error) {
          statusMessage("Could not create product: " + error.message, true);
        });
      });

      document.getElementById("loadWorkspaceRulesBtn").addEventListener("click", exportWorkspaceRules);

      loadWorkspace();
    </script>
  </body>
</html>
