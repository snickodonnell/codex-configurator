<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Sales Configurator</title>
    <style>
      body{font-family:Arial,sans-serif;margin:2rem;max-width:1000px}
      label{display:block;margin:.5rem 0}
      input{min-width:220px}
      pre{background:#f5f5f5;padding:1rem;overflow:auto}
      .panel{border:1px solid #ddd;padding:1rem;margin:1rem 0;border-radius:6px}
      .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
      .meta{color:#666;font-size:.9rem}
    </style>
  </head>
  <body>
    <h1>Sales Configuration Memo</h1>
    <p>Demo access: customer <code>demo-customer</code>, key <code>demo-key</code>.</p>
    <form method="post" action="/logout"><button type="submit">Logout</button></form>

    <div class="panel">
      <label>Environment <input name="environment" id="environment" value="dev"></label>
      <label>Customer ID <input name="customer_id" id="customer_id" value="demo-customer"></label>
      <label>API Key <input name="api_key" id="api_key" value="demo-key"></label>
      <button type="button" id="load-memo">Load Memo Inputs</button>
      <p class="meta" id="memo-version">No memo schema loaded.</p>
    </div>

    <form id="config-form" class="panel">
      <h2>Required Memo Inputs</h2>
      <div id="required-inputs" class="grid"></div>

      <h3>Optional Inputs</h3>
      <div id="optional-inputs" class="grid"></div>

      <button type="button" id="evaluate">Evaluate Memo</button>
      <button type="button" id="submit">Submit Specification</button>
    </form>

    <div class="panel">
      <h2>Rules-Engine Intermediate/Optional Parameters</h2>
      <ul id="intermediate-list"></ul>
    </div>

    <h2>Result</h2>
    <pre id="result">Load memo schema and evaluate to view outcomes.</pre>

    <script>
      const requiredContainer = document.getElementById('required-inputs');
      const optionalContainer = document.getElementById('optional-inputs');
      const intermediateList = document.getElementById('intermediate-list');
      const output = document.getElementById('result');
      const memoVersion = document.getElementById('memo-version');

      let memoSchema = null;

      function inputType(dataType) {
        if (dataType === 'number') return 'number';
        if (dataType === 'boolean') return 'checkbox';
        return 'text';
      }

      function defaultValueFor(name) {
        const defaults = {quantity: 1, base_price: 100, discount: 0.1, region: 'NA'};
        return defaults[name] ?? '';
      }

      function renderParameter(container, parameter) {
        const id = `param-${parameter.name}`;
        const wrapper = document.createElement('label');
        wrapper.innerHTML = `${parameter.label} <input id="${id}" data-parameter-name="${parameter.name}" type="${inputType(parameter.data_type)}">`;
        container.appendChild(wrapper);

        const input = document.getElementById(id);
        if (input.type === 'checkbox') {
          input.checked = Boolean(defaultValueFor(parameter.name));
        } else {
          input.value = defaultValueFor(parameter.name);
        }
      }

      function renderSchema(schema) {
        requiredContainer.innerHTML = '';
        optionalContainer.innerHTML = '';
        intermediateList.innerHTML = '';

        schema.required_input.forEach(param => renderParameter(requiredContainer, param));
        schema.optional_input.forEach(param => renderParameter(optionalContainer, param));

        [...schema.optional_input, ...schema.intermediate].forEach(param => {
          const item = document.createElement('li');
          item.textContent = `${param.name} (${param.parameter_class}) â†’ property: ${param.rules_engine_property}`;
          intermediateList.appendChild(item);
        });

        memoVersion.textContent = `Memo bound to ${schema.product_name}/${schema.category}/${schema.subcategory} v${schema.version}`;
      }

      async function loadSchema() {
        const environment = document.getElementById('environment').value;
        const response = await fetch(`/api/configuration-memo?environment=${encodeURIComponent(environment)}`);
        memoSchema = await response.json();
        renderSchema(memoSchema);
      }

      function readValue(input) {
        if (input.type === 'number') return Number(input.value);
        if (input.type === 'checkbox') return input.checked;
        return input.value;
      }

      function payload() {
        const config = {};
        document.querySelectorAll('[data-parameter-name]').forEach((input) => {
          const name = input.dataset.parameterName;
          if (input.value === '') return;
          config[name] = readValue(input);
        });
        return {
          customer_id: document.getElementById('customer_id').value,
          api_key: document.getElementById('api_key').value,
          environment: document.getElementById('environment').value,
          configuration: config
        };
      }

      document.getElementById('load-memo').onclick = loadSchema;

      document.getElementById('evaluate').onclick = async () => {
        const res = await fetch('/api/evaluate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload())
        });
        output.textContent = JSON.stringify(await res.json(), null, 2);
      };

      document.getElementById('submit').onclick = async () => {
        const base = payload();
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            customer_id: base.customer_id,
            api_key: base.api_key,
            environment: base.environment,
            specification: base.configuration
          })
        });
        output.textContent = JSON.stringify(await res.json(), null, 2);
      };

      loadSchema();
    </script>
  </body>
</html>
