<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Customer Project Configurator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <style>
      .col { display: grid; gap: .6rem; }
      .project { border: 1px solid var(--border); border-radius: 10px; padding: .7rem; margin-bottom: .7rem; background: #fbfdff; }
      .project.selected { border-color: var(--accent); background: #f6f5ff; }
      .field { border: 1px solid var(--border); border-radius: 8px; padding: .55rem; background: #fff; }
      .rules { max-height: 260px; overflow: auto; }
    </style>
  </head>
  <body>
    <div class="page stack">
      <div class="topbar">
        <div>
          <h1 style="margin:0;">Customer Project Configurator</h1>
          <p class="muted" style="margin:.4rem 0 0;">Create projects, attach products with quantities, and run configuration with rules/category enforcement and Studio display controls.</p>
        </div>
        <form method="post" action="/logout"><button type="submit">Logout</button></form>
      </div>

      <div class="layout-two-col">
      <div class="card col">
        <h2>Project Workspace</h2>
        <label>Environment <input id="environment" value="dev" /></label>
        <label>Customer ID <input id="customer-id" value="demo-customer" /></label>
        <label>API Key <input id="api-key" value="demo-key" /></label>
        <label>Project Name <input id="project-name" placeholder="Customer Pilot" /></label>
        <label>Project Notes <textarea id="project-notes" rows="2"></textarea></label>
        <button id="create-project" type="button">Create Project</button>
        <div id="project-list"></div>
      </div>

      <div class="card col">
        <h2 id="selected-project-title">Configuration</h2>
        <div class="row">
          <label style="flex:1">Add Product
            <select id="workspace-product"></select>
          </label>
          <label style="width:120px">Qty <input id="add-qty" type="number" min="1" value="1" /></label>
          <button id="add-product" type="button">Add</button>
        </div>

        <div id="project-products" class="col"></div>

        <div id="configuration-area" class="col" style="display:none;">
          <h3 id="config-product-name"></h3>
          <div id="status-strip" class="row"></div>
          <div id="inputs" class="grid-auto"></div>
          <h4>Rule Category Enforcement</h4>
          <div id="workspace-rules" class="rules"></div>
          <button id="evaluate" type="button">Save + Evaluate Configuration</button>
          <pre id="result" class="code-block">Choose a project product to configure.</pre>
        </div>
      </div>
      </div>
    </div>

    <script>
      let workspaceProducts = [];
      let projects = [];
      let selectedProjectId = null;
      let selectedProjectProductId = null;
      let configPayload = null;

      async function jsonFetch(url, options={}) {
        const res = await fetch(url, {headers:{'Content-Type':'application/json'}, ...options});
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      }

      function selectedProject() { return projects.find((p) => p.id === selectedProjectId); }

      function renderProjectList() {
        const holder = document.getElementById('project-list');
        holder.innerHTML = '';
        projects.forEach((project) => {
          const div = document.createElement('div');
          div.className = `project ${project.id === selectedProjectId ? 'selected' : ''}`;
          div.innerHTML = `
            <strong>${project.name}</strong>
            <span class="pill">Project Status: ${project.project_status}</span>
            <div class="muted">${project.notes || ''}</div>
            <div class="row">
              <button data-action="open">Open</button>
              <button data-action="save">Save Meta</button>
              <button data-action="delete" class="danger" type="button">Delete</button>
            </div>`;
          const statusSelect = document.createElement('select');
          ['draft','in_progress','configured','submitted'].forEach((v) => {
            const o = document.createElement('option'); o.value=v; o.textContent=v; if(v===project.project_status) o.selected=true; statusSelect.appendChild(o);
          });
          div.appendChild(statusSelect);
          div.querySelector('[data-action="open"]').onclick = () => { selectedProjectId = project.id; renderProjectList(); renderProjectProducts(); };
          div.querySelector('[data-action="save"]').onclick = async () => {
            await jsonFetch(`/api/projects/${project.id}`, {method:'PUT', body: JSON.stringify({name: project.name, notes: project.notes || '', project_status: statusSelect.value})});
            await loadProjects();
          };
          div.querySelector('[data-action="delete"]').onclick = async () => {
            await jsonFetch(`/api/projects/${project.id}`, {method:'DELETE'});
            if (selectedProjectId === project.id) selectedProjectId = null;
            await loadProjects();
          };
          holder.appendChild(div);
        });
      }

      function renderProjectProducts() {
        const project = selectedProject();
        const holder = document.getElementById('project-products');
        document.getElementById('selected-project-title').textContent = project ? `Configuration • ${project.name}` : 'Configuration';
        holder.innerHTML = '';
        if (!project) return;
        project.products.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'project';
          row.innerHTML = `<strong>${item.product_name}</strong> <span class="pill">Configuration Status: ${item.configuration_status}</span>`;

          const qty = document.createElement('input'); qty.type = 'number'; qty.min = '1'; qty.value = item.quantity;
          const status = document.createElement('select');
          ['not_started','in_progress','ready','attention_required'].forEach((v)=>{const o=document.createElement('option');o.value=v;o.textContent=v;if(v===item.configuration_status)o.selected=true;status.appendChild(o);});
          const actions = document.createElement('div'); actions.className = 'row';
          const open = document.createElement('button'); open.textContent = 'Configure';
          const save = document.createElement('button'); save.textContent = 'Save';
          const remove = document.createElement('button'); remove.textContent = 'Remove'; remove.className = 'danger';
          actions.append(qty,status,open,save,remove);
          row.appendChild(actions);

          open.onclick = async () => { selectedProjectProductId = item.id; await loadConfiguration(); };
          save.onclick = async () => {
            await jsonFetch(`/api/projects/${project.id}/products/${item.id}`, {method:'PUT', body: JSON.stringify({quantity: Number(qty.value), configuration_status: status.value})});
            await loadProjects();
          };
          remove.onclick = async () => {
            await jsonFetch(`/api/projects/${project.id}/products/${item.id}`, {method:'DELETE'});
            if (selectedProjectProductId === item.id) { selectedProjectProductId = null; document.getElementById('configuration-area').style.display='none'; }
            await loadProjects();
          };
          holder.appendChild(row);
        });
      }

      function createInput(control, value) {
        const wrap = document.createElement('div'); wrap.className = 'field';
        wrap.innerHTML = `<strong>${control.display_label}</strong><div class="muted">${control.help_text || ''}</div>`;
        const id = `param-${control.parameter_name}`;
        let input;
        if (control.control_type === 'dropdown') {
          input = document.createElement('select');
          control.options.forEach((opt)=>{const o=document.createElement('option'); o.value=opt.option_value; o.textContent=opt.option_label; input.appendChild(o);});
        } else {
          input = document.createElement('input');
          input.type = control.control_type === 'number' ? 'number' : 'text';
          if (control.min_value !== null) input.min = control.min_value;
          if (control.max_value !== null) input.max = control.max_value;
          if (control.step_value !== null) input.step = control.step_value;
          input.placeholder = control.placeholder || '';
        }
        input.id = id; input.dataset.parameterName = control.parameter_name;
        if (value !== undefined && value !== null) input.value = value;
        wrap.appendChild(input);
        return wrap;
      }

      async function loadConfiguration() {
        const project = selectedProject();
        if (!project || !selectedProjectProductId) return;
        configPayload = await jsonFetch(`/api/projects/${project.id}/configuration?item_id=${selectedProjectProductId}`);
        document.getElementById('configuration-area').style.display = 'grid';
        document.getElementById('config-product-name').textContent = `${configPayload.product_name} Configuration`;
        document.getElementById('status-strip').innerHTML = `<span class="pill">Project: ${configPayload.project.project_status}</span><span class="pill">Configuration: ${project.products.find((x)=>x.id===selectedProjectProductId)?.configuration_status || 'not_started'}</span><span class="pill">Ruleset ${configPayload.schema.category} / ${configPayload.schema.subcategory}</span>`;

        const inputs = document.getElementById('inputs'); inputs.innerHTML = '';
        configPayload.controls.forEach((control) => inputs.appendChild(createInput(control, configPayload.configuration_state[control.parameter_name])));

        const rules = document.getElementById('workspace-rules');
        rules.innerHTML = configPayload.workspace_rules.map((rule) => `<div class="field"><strong>${rule.category_name}${rule.subcategory_name ? ` → ${rule.subcategory_name}` : ''}</strong><div>${rule.expression}</div><div class="muted">${rule.message || ''}</div></div>`).join('') || '<div class="muted">No workspace rules configured for this product.</div>';
      }

      function configurationPayload() {
        const cfg = {};
        document.querySelectorAll('[data-parameter-name]').forEach((input) => {
          if (input.value === '') return;
          cfg[input.dataset.parameterName] = input.type === 'number' ? Number(input.value) : input.value;
        });
        return cfg;
      }

      async function evaluateConfiguration() {
        const project = selectedProject();
        const body = {
          customer_id: document.getElementById('customer-id').value,
          api_key: document.getElementById('api-key').value,
          configuration: configurationPayload(),
        };
        const out = await jsonFetch(`/api/projects/${project.id}/products/${selectedProjectProductId}/evaluate`, {method:'POST', body: JSON.stringify(body)});
        document.getElementById('result').textContent = JSON.stringify(out, null, 2);
        await loadProjects();
      }

      async function loadWorkspaceProducts() {
        const data = await jsonFetch('/api/workspace-products');
        workspaceProducts = data.products;
        const select = document.getElementById('workspace-product');
        select.innerHTML = '';
        workspaceProducts.forEach((p)=>{const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; select.appendChild(o);});
      }

      async function loadProjects() {
        const customerId = document.getElementById('customer-id').value;
        const env = document.getElementById('environment').value;
        const data = await jsonFetch(`/api/projects?customer_id=${encodeURIComponent(customerId)}&environment=${encodeURIComponent(env)}`);
        projects = data.projects;
        if (!projects.some((p)=>p.id===selectedProjectId)) selectedProjectId = projects[0]?.id || null;
        renderProjectList();
        renderProjectProducts();
      }

      document.getElementById('create-project').onclick = async () => {
        await jsonFetch('/api/projects', {method:'POST', body: JSON.stringify({
          customer_id: document.getElementById('customer-id').value,
          environment: document.getElementById('environment').value,
          name: document.getElementById('project-name').value || 'New Project',
          notes: document.getElementById('project-notes').value,
          project_status: 'draft',
        })});
        document.getElementById('project-name').value = '';
        document.getElementById('project-notes').value = '';
        await loadProjects();
      };

      document.getElementById('add-product').onclick = async () => {
        const project = selectedProject();
        if (!project) return;
        await jsonFetch(`/api/projects/${project.id}/products`, {method:'POST', body: JSON.stringify({workspace_product_id: Number(document.getElementById('workspace-product').value), quantity: Number(document.getElementById('add-qty').value)})});
        await loadProjects();
      };

      document.getElementById('evaluate').onclick = evaluateConfiguration;
      document.getElementById('customer-id').onchange = loadProjects;
      document.getElementById('environment').onchange = loadProjects;

      (async function boot(){ await loadWorkspaceProducts(); await loadProjects(); })();
    </script>
  </body>
</html>
