<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ShopFloor Configurator</title>
    <style>
      body{font-family:Arial,sans-serif;margin:2rem;max-width:1100px}
      pre{background:#f5f5f5;padding:1rem;overflow:auto}
      .panel{border:1px solid #ddd;padding:1rem;margin:1rem 0;border-radius:6px}
      .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
      .field{border:1px solid #e2e6f5;padding:.8rem;border-radius:8px}
      .field.card{background:#f8faff}.field.accent{border-color:#7f8cff}.field.pill{border-radius:30px}
      .opt-buttons button{margin-right:.35rem}
      img.preview{max-width:100px;max-height:60px;display:block;margin:.3rem 0}
    </style>
  </head>
  <body>
    <h1>ShopFloor Configurator</h1>
    <p>Runtime configuration UI driven by Experience Studio mappings.</p>
    <form method="post" action="/logout"><button type="submit">Logout</button></form>

    <div class="panel">
      <label>Environment <input name="environment" id="environment" value="dev"></label>
      <label>Customer ID <input name="customer_id" id="customer_id" value="demo-customer"></label>
      <label>API Key <input name="api_key" id="api_key" value="demo-key"></label>
      <button type="button" id="load-memo">Load Configuration Schema</button>
      <p id="memo-version">No memo schema loaded.</p>
    </div>

    <form id="config-form" class="panel">
      <h2>Inputs</h2>
      <div id="inputs" class="grid"></div>
      <button type="button" id="evaluate">Evaluate Memo</button>
      <button type="button" id="submit">Submit Specification</button>
    </form>

    <h2>Result</h2>
    <pre id="result">Load schema and evaluate to view outcomes.</pre>

    <script>
      const inputs = document.getElementById('inputs');
      const output = document.getElementById('result');
      const memoVersion = document.getElementById('memo-version');
      let uiSchema = null;

      function defaultValueFor(name){return ({quantity:1, base_price:100, discount:0.1, region:'NA'})[name] ?? '';}

      function createOptionImage(url){
        if(!url) return null;
        const img = document.createElement('img');
        img.src = url;
        img.className = 'preview';
        return img;
      }

      function appendControl(wrapper, control){
        const id = `param-${control.parameter_name}`;
        if(control.control_type === 'radio_boolean'){
          wrapper.innerHTML += `<label><input type="radio" name="${id}" data-parameter-name="${control.parameter_name}" value="true"> Yes</label><label><input type="radio" name="${id}" data-parameter-name="${control.parameter_name}" value="false"> No</label>`;
          return;
        }
        if(control.control_type === 'slider'){
          wrapper.innerHTML += `<input type="range" id="${id}" data-parameter-name="${control.parameter_name}" min="${control.min_value ?? 0}" max="${control.max_value ?? 100}" step="${control.step_value ?? 1}" value="${defaultValueFor(control.parameter_name)}"> <span id="${id}-value"></span>`;
          setTimeout(()=>{
            const slider = document.getElementById(id);
            const value = document.getElementById(`${id}-value`);
            value.textContent = slider.value;
            slider.oninput = ()=> value.textContent = slider.value;
          }, 0);
          return;
        }
        if(control.control_type === 'dropdown'){
          const select = document.createElement('select');
          select.id = id;
          select.dataset.parameterName = control.parameter_name;
          control.options.forEach((opt)=>{
            const option = document.createElement('option');
            option.value = opt.option_value;
            option.textContent = opt.option_label;
            select.appendChild(option);
          });
          wrapper.appendChild(select);
          return;
        }
        if(control.control_type === 'button_group'){
          const holder = document.createElement('div');
          holder.className = 'opt-buttons';
          control.options.forEach((opt)=>{
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = opt.option_label;
            button.dataset.value = opt.option_value;
            button.dataset.parameterName = control.parameter_name;
            button.onclick = ()=>{
              holder.querySelectorAll('button').forEach((btn)=> btn.style.background='');
              button.style.background = '#c8cffc';
              holder.dataset.selectedValue = opt.option_value;
            };
            holder.appendChild(button);
            const img = createOptionImage(opt.image_url);
            if(img) holder.appendChild(img);
          });
          wrapper.appendChild(holder);
          return;
        }
        const type = control.control_type === 'number' ? 'number' : 'text';
        wrapper.innerHTML += `<input id="${id}" data-parameter-name="${control.parameter_name}" type="${type}" placeholder="${control.placeholder || ''}" value="${defaultValueFor(control.parameter_name)}">`;
      }

      function renderSchema(body){
        uiSchema = body;
        inputs.innerHTML = '';
        body.controls.forEach((control)=>{
          const wrapper = document.createElement('div');
          wrapper.className = `field ${control.display_style || ''}`;
          wrapper.innerHTML = `<strong>${control.display_label}</strong><div>${control.help_text || ''}</div>`;
          const img = createOptionImage(control.image_url);
          if(img) wrapper.appendChild(img);
          appendControl(wrapper, control);
          inputs.appendChild(wrapper);
        });
        const schema = body.schema;
        memoVersion.textContent = `Memo bound to ${schema.product_name}/${schema.category}/${schema.subcategory} v${schema.version}`;
      }

      async function loadSchema(){
        const environment = document.getElementById('environment').value;
        const response = await fetch(`/api/ui-schema?environment=${encodeURIComponent(environment)}`);
        renderSchema(await response.json());
      }

      function readValue(input){
        if(input.type === 'number' || input.type === 'range') return Number(input.value);
        return input.value;
      }

      function payload(){
        const config = {};
        document.querySelectorAll('[data-parameter-name]').forEach((input)=>{
          const name = input.dataset.parameterName;
          if(input.type === 'radio') {
            if(input.checked) config[name] = input.value === 'true';
            return;
          }
          if(input.tagName === 'BUTTON') return;
          if(input.value === '') return;
          config[name] = readValue(input);
        });
        document.querySelectorAll('.opt-buttons').forEach((holder)=>{
          const btn = holder.querySelector('button[data-parameter-name]');
          if(btn && holder.dataset.selectedValue) config[btn.dataset.parameterName] = holder.dataset.selectedValue;
        });
        return {
          customer_id: document.getElementById('customer_id').value,
          api_key: document.getElementById('api_key').value,
          environment: document.getElementById('environment').value,
          configuration: config
        };
      }

      document.getElementById('load-memo').onclick = loadSchema;
      document.getElementById('evaluate').onclick = async ()=>{
        const res = await fetch('/api/evaluate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload())});
        output.textContent = JSON.stringify(await res.json(), null, 2);
      };
      document.getElementById('submit').onclick = async ()=>{
        const base = payload();
        const res = await fetch('/api/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({customer_id:base.customer_id, api_key:base.api_key, environment:base.environment, specification:base.configuration})});
        output.textContent = JSON.stringify(await res.json(), null, 2);
      };

      loadSchema();
    </script>
  </body>
</html>
